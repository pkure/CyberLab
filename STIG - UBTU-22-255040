UBTU-22-255040 — Disable Remote X Connections

STIG ID: UBTU-22-255040
Title: Ubuntu 22.04 LTS must be configured so that remote X connections are disabled, unless to fulfill documented and validated mission requirements.
Discussion: Allowing remote X11 connections (e.g., via SSH forwarding) can expose the system to keylogging, screen scraping, or privilege escalation. Unless explicitly required and documented, remote X access must be disabled.

Check

Run the following command to verify the setting:

sudo grep -i "X11Forwarding" /etc/ssh/sshd_config /etc/ssh/sshd_config.d/* 2>/dev/null


Expected result:

X11Forwarding no


If the value is set to yes or commented out (default is often yes), this is a finding.

Fix

Create a backup, then update the SSH configuration:

# Backup existing config
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak.$(date +%F)

# Ensure X11Forwarding is disabled
sudo sed -i 's/^[#]*X11Forwarding.*/X11Forwarding no/' /etc/ssh/sshd_config

# Restart SSH to apply
sudo systemctl restart sshd

Rollback

If required to restore the previous state:

# Restore backup
sudo cp /etc/ssh/sshd_config.bak.YYYY-MM-DD /etc/ssh/sshd_config

# Restart SSH
sudo systemctl restart sshd


(Replace YYYY-MM-DD with the actual date of the backup file.)

Automation Script

Here’s a Bash script to enforce this setting, check compliance, and support rollback:


Save as UBTU-22-255040.sh:

___________________________________________________________________________

#!/usr/bin/env bash
# UBTU-22-255040 - Disable remote X connections (X11Forwarding)
# Usage: sudo ./UBTU-22-255040.sh [check|remediate|rollback]

set -euo pipefail

CONFIG_MAIN="/etc/ssh/sshd_config"
SNIPPETS_DIR="/etc/ssh/sshd_config.d"
BACKUP_DIR="/etc/ssh/backup_stigs"
TS="$(date +%F_%H%M%S)"
BACKUP_TAR="$BACKUP_DIR/sshd_backup_$TS.tgz"

need_root() {
  if [[ $EUID -ne 0 ]]; then
    echo "This action requires root. Re-run with: sudo $0 $1" >&2
    exit 2
  fi
}

check() {
  if sshd -T 2>/dev/null | grep -qi '^x11forwarding no$'; then
    echo "PASS: Effective X11Forwarding is 'no'"
    exit 0
  else
    current="$(sshd -T 2>/dev/null | awk '/^x11forwarding /{print $2}')"
    current="${current:-unknown}"
    echo "FAIL: Effective X11Forwarding is '$current' (expected 'no')"
    grep -RinE '^[[:space:]]*#?[[:space:]]*X11Forwarding[[:space:]]+' "$CONFIG_MAIN" "$SNIPPETS_DIR" 2>/dev/null || true
    exit 1
  fi
}

backup_all() {
  mkdir -p "$BACKUP_DIR"
  tar -czf "$BACKUP_TAR" \
    --ignore-failed-read \
    "$CONFIG_MAIN" "$SNIPPETS_DIR" 2>/dev/null || true
  echo "[*] Backup created: $BACKUP_TAR"
}

remediate() {
  need_root remediate
  backup_all

  # Fix in main config
  if grep -Ei '^[[:space:]]*#?[[:space:]]*X11Forwarding[[:space:]]+' "$CONFIG_MAIN" >/dev/null; then
    sed -Ei 's/^[[:space:]]*#?[[:space:]]*X11Forwarding[[:space:]]+.*/X11Forwarding no/' "$CONFIG_MAIN"
  else
    echo "X11Forwarding no" >> "$CONFIG_MAIN"
  fi

  # Fix in snippets
  if [[ -d "$SNIPPETS_DIR" ]]; then
    sed -Ei 's/^[[:space:]]*#?[[:space:]]*X11Forwarding[[:space:]]+.*/X11Forwarding no/' "$SNIPPETS_DIR"/*.conf 2>/dev/null || true
  fi

  # Validate config
  if ! sshd -t 2>/dev/null; then
    echo "[-] sshd config test failed. Restoring backup..."
    rollback
    exit 1
  fi

  # Restart SSH
  if systemctl list-unit-files | grep -q '^ssh\.service'; then
    systemctl restart ssh
  else
    systemctl restart sshd || service ssh restart || service sshd restart
  fi

  echo "[+] Remediation complete. Verifying..."
  check
}

rollback() {
  need_root rollback
  latest="$(ls -t "$BACKUP_DIR"/sshd_backup_*.tgz 2>/dev/null | head -n1 || true)"
  if [[ -z "$latest" ]]; then
    echo "[-] No backup archives found in $BACKUP_DIR"
    exit 1
  fi
  echo "[*] Restoring from $latest"
  tar -xzf "$latest" -C / || { echo "[-] Restore failed"; exit 1; }

  if ! sshd -t 2>/dev/null; then
    echo "[-] Restored config is invalid. Please inspect manually."
    exit 1
  fi

  if systemctl list-unit-files | grep -q '^ssh\.service'; then
    systemctl restart ssh
  else
    systemctl restart sshd || service ssh restart || service sshd restart
  fi

  echo "[+] Rollback complete."
}

case "${1:-}" in
  check)     check ;;
  remediate) remediate ;;
  rollback)  rollback ;;
  *)
    echo "Usage: $0 [check|remediate|rollback]"
    exit 1
    ;;
esac

___________________________________________________________________________



# Make script executable
chmod +x UBTU-22-255040.sh

# Check current compliance state
sudo ./UBTU-22-255040.sh check

# Remediate (disable remote X connections and restart sshd)
sudo ./UBTU-22-255040.sh remediate

# Rollback to the most recent backup
sudo ./UBTU-22-255040.sh rollback
