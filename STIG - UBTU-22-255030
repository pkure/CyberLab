UBTU-22-255030 â€” SSH idle/unresponsive session termination

STIG ID: UBTU-22-255030
Title: Ubuntu 22.04 LTS must be configured so that all network connections associated with SSH traffic terminate after becoming unresponsive.
Why it matters: Idle SSH sessions consume resources and create a risk of hijack if left unattended. Configuring timeouts ensures abandoned sessions are dropped.

Check

Verify the following settings in /etc/ssh/sshd_config (or drop-in configs under /etc/ssh/sshd_config.d/):

sudo grep -iE 'ClientAliveInterval|ClientAliveCountMax' /etc/ssh/sshd_config /etc/ssh/sshd_config.d/* 2>/dev/null


Expected values:

ClientAliveInterval 300
ClientAliveCountMax 0


This means: after 300 seconds (5 min) of inactivity, with 0 retries, the session terminates.

If ClientAliveInterval is unset or too high, or if ClientAliveCountMax > 0, this is a finding.

Fix (policy)

Edit /etc/ssh/sshd_config (or a snippet in /etc/ssh/sshd_config.d/) and set:

ClientAliveInterval 300
ClientAliveCountMax 0


Then restart the SSH service:

sudo systemctl restart ssh

Rollback

Restore the original sshd_config from backup and restart the service:

sudo cp /etc/ssh/sshd_config.bak.YYYY-MM-DD /etc/ssh/sshd_config
sudo systemctl restart ssh

Automation Script

Save as UBTU-22-255030.sh:


__________________________________________________________________________


#!/usr/bin/env bash
# UBTU-22-255030 - SSH idle/unresponsive session termination
# Usage: sudo ./UBTU-22-255030.sh [check|remediate|rollback]

set -euo pipefail

CONFIG_MAIN="/etc/ssh/sshd_config"
SNIPPETS_DIR="/etc/ssh/sshd_config.d"
STIG_SNIPPET="${SNIPPETS_DIR}/99-stig-idle-timeout.conf"

BACKUP_DIR="/etc/ssh/backup_stigs"
TS="$(date +%F_%H%M%S)"
BACKUP_TAR="${BACKUP_DIR}/ssh_UBTU-22-255030_${TS}.tgz"

need_root() {
  if [[ $EUID -ne 0 ]]; then
    echo "This action requires root. Re-run with: sudo $0 $1" >&2
    exit 2
  fi
}

reload_sshd() {
  if ! sshd -t 2>/dev/null; then
    echo "[-] sshd config test failed" >&2
    return 1
  fi
  systemctl restart ssh || systemctl restart sshd || service ssh restart
}

backup_all() {
  mkdir -p "$BACKUP_DIR"
  tar -czf "$BACKUP_TAR" \
    --ignore-failed-read \
    "$CONFIG_MAIN" "$SNIPPETS_DIR" 2>/dev/null || true
  echo "[*] Backup created: $BACKUP_TAR"
}

show_effective() {
  local interval count
  interval="$(sshd -T | awk '/^clientaliveinterval/{print $2}')"
  count="$(sshd -T | awk '/^clientalivecountmax/{print $2}')"
  echo "ClientAliveInterval = ${interval:-unset}"
  echo "ClientAliveCountMax = ${count:-unset}"
  [[ "$interval" == "300" && "$count" == "0" ]]
}

check() {
  if show_effective; then
    echo "PASS: SSH idle timeout is compliant"
    exit 0
  else
    echo "FAIL: SSH idle timeout not compliant"
    # Show where values are set
    grep -RinE '^\s*#?\s*ClientAlive(Interval|CountMax)\s+' "$CONFIG_MAIN" "$SNIPPETS_DIR" 2>/dev/null || true
    exit 1
  fi
}

remediate() {
  need_root remediate
  backup_all
  mkdir -p "$SNIPPETS_DIR"

  # Remove any existing ClientAlive* lines from main and snippets
  sed -Ei '/^[[:space:]]*#?[[:space:]]*ClientAlive(Interval|CountMax)[[:space:]]+/d' "$CONFIG_MAIN" || true
  if compgen -G "$SNIPPETS_DIR/*.conf" >/dev/null; then
    sed -Ei '/^[[:space:]]*#?[[:space:]]*ClientAlive(Interval|CountMax)[[:space:]]+/d' "$SNIPPETS_DIR"/*.conf || true
  fi

  # Write a dedicated STIG snippet that sets the required values
  cat > "$STIG_SNIPPET" <<'EOF'
# Enforced by STIG UBTU-22-255030
ClientAliveInterval 300
ClientAliveCountMax 0
EOF

  if ! reload_sshd; then
    echo "[-] Reload failed. Restoring backup..." >&2
    rollback
    exit 1
  fi

  echo "[+] Remediation complete."
  if show_effective; then
    echo "PASS: SSH idle timeout is now compliant"
  else
    echo "WARN: Effective values still not compliant; investigate include order and local overrides."
    exit 1
  fi
}

rollback() {
  need_root rollback
  local latest
  latest="$(ls -t "$BACKUP_DIR"/ssh_UBTU-22-255030_*.tgz 2>/dev/null | head -n1 || true)"
  if [[ -z "$latest" ]]; then
    echo "[-] No backup archives found in $BACKUP_DIR"
    exit 1
  fi
  echo "[*] Restoring from $latest"
  tar -xzf "$latest" -C / || { echo "[-] Restore failed"; exit 1; }
  reload_sshd
  echo "[+] Rollback complete."
}

case "${1:-}" in
  check)      check ;;
  remediate)  remediate ;;
  rollback)   rollback ;;
  *) echo "Usage: $0 [check|remediate|rollback]"; exit 1 ;;
esac


__________________________________________________________________________


Usage
chmod +x UBTU-22-255030.sh

# Check current state
sudo ./UBTU-22-255030.sh check

# Enforce STIG values
sudo ./UBTU-22-255030.sh remediate

# Roll back to most recent backup
sudo ./UBTU-22-255030.sh rollback
